import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import requests
from bs4 import BeautifulSoup
import yfinance as yf

# Function to fetch inflation data
def fetch_inflation(country, api_key):
    url = f"https://api.api-ninjas.com/v1/inflation?country={country}"
    headers = {'X-Api-Key': api_key}
    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        return response.json()[0]
    else:
        return None

# Function to fetch US yield curve data from FRED
def fetch_us_yield(fred_api_key):
    url = f"https://api.stlouisfed.org/fred/series/observations?series_id=GS10&api_key={fred_api_key}&file_type=json"
    response = requests.get(url)
    if response.status_code == 200:
        data = response.json()['observations']
        return pd.DataFrame(data)

# Function to scrape news from Yahoo Finance
def fetch_yahoo_finance_news():
    url = "https://finance.yahoo.com/"
    response = requests.get(url)
    soup = BeautifulSoup(response.content, 'html.parser')

    headlines = []
    for item in soup.find_all('h3', {'class': lambda x: x and 'Mb(5px)' in x}):
        text = item.get_text()
        if text:
            headlines.append(text)

    return headlines[:5]

# Read UK yield data from Excel file
uk_yield_data = pd.read_excel('/mnt/data/GLC Nominal daily data current month.xlsx', sheet_name='1. fwds, short end', skiprows=4)
uk_yield_data = uk_yield_data.rename(columns={uk_yield_data.columns[0]: 'Date'}).dropna(subset=['Date'])
uk_yield_data.set_index('Date', inplace=True)

# Streamlit App
st.title("Dynamic Market Overview")

# Market News Headlines
st.subheader("Market News Headlines")
headlines = fetch_yahoo_finance_news()
for headline in headlines:
    st.write(f"- {headline}")

# Section: Interest Rates and Inflation
st.subheader("Interest Rates and Inflation")
api_key = 'P3jnaeiRz/shEPn4iOKD6A==aaPYULKIx9Xi7xNS'
us_inflation = fetch_inflation('United States', api_key)
uk_inflation = fetch_inflation('United Kingdom', api_key)
st.write(f"US Inflation: {us_inflation['yearly_rate_pct']}%")
st.write(f"UK Inflation: {uk_inflation['yearly_rate_pct']}%")

# Section: Yield Curves
st.subheader("Yield Curves")

# Fetch and plot US Yield Curve
fred_api_key = '5da565b90c3bd82a6514a1b3322a43c8'
us_yield_data = fetch_us_yield(fred_api_key)
show_us_yield = st.checkbox('Show US Yield Curve')
if show_us_yield:
    plt.plot(us_yield_data['date'], us_yield_data['value'])
    plt.title('US Yield Curve')
    plt.xlabel('Date')
    plt.ylabel('Yield')
    st.pyplot()

# Plot UK Yield Curve
show_uk_yield = st.checkbox('Show UK Yield Curve')
if show_uk_yield:
    plt.plot(uk_yield_data.index, uk_yield_data['Unnamed: 4'])
    plt.title('UK Yield Curve')
    plt.xlabel('Date')
    plt.ylabel('Yield')
    st.pyplot()

# Section: Equity Indices
st.subheader("Key Equity Indices")
indices = ['^N225', '^DJI', '^GSPC', '^FTSE']
index_data = {index: yf.Ticker(index).info for index in indices}
st.write(pd.DataFrame(index_data).T[['longName', 'regularMarketPrice', 'regularMarketChange', 'regularMarketChangePercent']])
