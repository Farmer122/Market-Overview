import streamlit as st
import pandas as pd
import plotly.express as px
import requests
from bs4 import BeautifulSoup
from textblob import TextBlob
import spacy
nlp = spacy.load("en_core_web_sm")

# Function to scrape news from Yahoo Finance and perform sentiment analysis
def fetch_yahoo_finance_news():
    url = "https://uk.finance.yahoo.com/topic/news"
    response = requests.get(url)
    soup = BeautifulSoup(response.content, 'html.parser')
    headlines = {}
    
    for item in soup.find_all('h3', {'class': lambda x: x and 'Mb(5px)' in x}):
        text = item.get_text()
        link = item.a['href']
        blob = TextBlob(text)
        sentiment = blob.sentiment.polarity
        
        if text and link:
            headlines[text] = {
                'link': f"https://finance.yahoo.com{link}",
                'sentiment': sentiment
            }
    return headlines

# Web App Title
st.title("Jamal - Dynamic Market Overview")

# Market News Headlines
st.subheader("Market News Headlines")

headlines = fetch_yahoo_finance_news()
headline_list = list(headlines.keys())

# Create a 2x5 table for headlines with sentiment color
cols = st.columns(2)
with cols[0]:
    for headline in headline_list[:5]:
        sentiment = headlines[headline]['sentiment']
        st.markdown(f"<p style='background-color:{'lightgreen' if sentiment > 0.2 else 'lightcoral' if sentiment < 0 else 'white'};'>{headline}</p>", unsafe_allow_html=True)
with cols[1]:
    for headline in headline_list[5:10]:
        sentiment = headlines[headline]['sentiment']
        st.markdown(f"<p style='background-color:{'lightgreen' if sentiment > 0.2 else 'lightcoral' if sentiment < 0 else 'white'};'>{headline}</p>", unsafe_allow_html=True)

# Sentiment legend
st.subheader("Sentiment Analysis Legend")
st.markdown("<p style='background-color:lightgreen;'>Positive Sentiment</p>", unsafe_allow_html=True)
st.markdown("<p style='background-color:lightcoral;'>Negative Sentiment</p>", unsafe_allow_html=True)
st.markdown("<p style='background-color:white;'>Neutral Sentiment</p>", unsafe_allow_html=True)




def summarize_text(text):
    doc = nlp(text)
    sentences = [sentence.orth_ for sentence in doc.sents]
    return ' '.join(sentences[:3])  # Return the first 3 sentences as a summary

# Fetch the complete article text based on the URL (this is a placeholder; you'll need to implement this)
def fetch_article_text(url):
    response = requests.get(url)
    soup = BeautifulSoup(response.content, 'html.parser')
    paragraphs = soup.find_all('p')
    article_text = ' '.join([para.text for para in paragraphs])
    return article_text



# Dynamic News Summary
st.markdown("## **Select a headline for summary**")  # Made this text bold and bigger
selected_headline = st.selectbox('', headline_list)
if selected_headline:
    st.write(f"Summary for: {selected_headline}")
    summary_url = headlines[selected_headline]['link']
    full_article_text = fetch_article_text(summary_url)
    summary = summarize_text(full_article_text)
    st.write(f"Summary: {summary}")
    st.write(f"For more details, [click here]({summary_url})")



xapi = 'P3jnaeiRz/shEPn4iOKD6A==aaPYULKIx9Xi7xNS'

st.subheader('Exchange rate data')

api_url = 'https://api.api-ninjas.com/v1/exchangerate?pair=USD_EUR'
response = requests.get(api_url, headers={'X-Api-Key': xapi})
if response.status_code == requests.codes.ok:
    st.write(response.text)
else:
    print("Error:", response.status_code, response.text)

api_url = 'https://api.api-ninjas.com/v1/exchangerate?pair=USD_JPY'
response = requests.get(api_url, headers={'X-Api-Key': xapi})
if response.status_code == requests.codes.ok:
    st.write(response.text)
else:
    print("Error:", response.status_code, response.text)

api_url = 'https://api.api-ninjas.com/v1/exchangerate?pair=USD_GBP'
response = requests.get(api_url, headers={'X-Api-Key': xapi})
if response.status_code == requests.codes.ok:
    st.write(response.text)
else:
    print("Error:", response.status_code, response.text)





uk_yield_data = pd.read_csv(r"\\mfil.local\proddfs\appsense\profiles\users\N354792\Desktop\GLC Real DATA.csv")
### Here I would like to have Live data instead if possible
us_yield_data = pd.read_csv(r"\\mfil.local\proddfs\appsense\profiles\users\N354792\Desktop\US YIELD DATA.csv")

# Interactive Yield Curve Plots
st.subheader("Yield Curve")
yield_curve_choice = st.selectbox('Select Yield Curve', ['UK', 'US'])

if yield_curve_choice == 'UK':
    fig_uk = px.line(uk_yield_data, x='Maturity', y='Rates', title='UK Yield Curve')
    st.plotly_chart(fig_uk)
elif yield_curve_choice == 'US':
    fig_us = px.line(us_yield_data, x='Maturity', y='Rates', title='US Yield Curve')
    st.plotly_chart(fig_us)



# Inflation Rates
show_inflation = st.selectbox('Show Inflation Rates', ['UK', 'US', 'JP'])
if show_inflation == 'US':
    api_url = 'https://api.api-ninjas.com/v1/inflation?country={}'.format("United States")
    response = requests.get(api_url, headers={'X-Api-Key': 'P3jnaeiRz/shEPn4iOKD6A==aaPYULKIx9Xi7xNS'})
    if response.status_code == requests.codes.ok:
        inflation_data = response.json()[0]
        st.write(f"US Inflation Rate: {inflation_data['yearly_rate_pct']}%")
    else:
        st.write("Error fetching inflation data.")
elif show_inflation == 'UK':  # Fixed the comparison operator here
    api_url = 'https://api.api-ninjas.com/v1/inflation?country={}'.format("United Kingdom")
    response = requests.get(api_url, headers={'X-Api-Key': 'P3jnaeiRz/shEPn4iOKD6A==aaPYULKIx9Xi7xNS'})
    if response.status_code == requests.codes.ok:
        inflation_data = response.json()[0]
        st.write(f"UK Inflation Rate: {inflation_data['yearly_rate_pct']}%")  # Fixed the message here
    else:
        st.write("Error fetching inflation data.")
elif show_inflation == 'JP':  # Fixed the comparison operator here
    api_url = 'https://api.api-ninjas.com/v1/inflation?country={}'.format("Japan")
    response = requests.get(api_url, headers={'X-Api-Key': 'P3jnaeiRz/shEPn4iOKD6A==aaPYULKIx9Xi7xNS'})
    if response.status_code == requests.codes.ok:
        inflation_data = response.json()[0]
        st.write(f"UK Inflation Rate: {inflation_data['yearly_rate_pct']}%")  # Fixed the message here
    else:
        st.write("Error fetching inflation data.")



st.subheader("Economic Calendar")
iframe_code = '''
<iframe src="https://sslecal2.investing.com?columns=exc_flags,exc_currency,exc_importance,exc_actual,exc_forecast,exc_previous&features=datepicker,timezone&countries=25,32,6,37,72,22,17,39,14,10,35,43,56,36,110,11,26,12,4,5&calType=day&timeZone=15&lang=1" width="650" height="467" frameborder="0" allowtransparency="true" marginwidth="0" marginheight="0"></iframe>
'''
st.components.v1.html(iframe_code, height=500)
