import streamlit as st
import requests
from bs4 import BeautifulSoup
import matplotlib.pyplot as plt
import quandl
from datetime import date, timedelta

quandl.ApiConfig.api_key = "CMAmvGguyaxC5xiz2mq3"

def fetch_yahoo_finance_news():
    """Fetch top 5 news headlines from Yahoo Finance."""
    url = "https://uk.finance.yahoo.com/topic/news/"
    response = requests.get(url)
    soup = BeautifulSoup(response.content, 'html.parser')

    headlines = [item.get_text() for item in soup.find_all('h3', class_='Mb(5px)') if item and item.get_text()]
    return headlines[:5]

# Streamlit App
st.title("Financial Dashboard")

# Display News
st.subheader("Top 5 Financial News")
news = fetch_financial_news()
for i, article in enumerate(news):
    st.write(f"{i+1}. [{article['text']}]({article['link']})")

# Widgets
country = st.selectbox('Select Country for Yield Curve', ('UK', 'US', 'Eurozone'))
indicator = st.selectbox('Select Economic Indicator', ('Inflation Rate', 'Interest Rate'))

# Dynamic Dates
end_date = date.today()
start_date = end_date - timedelta(days=30)  # Last 30 days

# Fetch and Plot Yield Curve Data
if country == 'UK':
    data = quandl.get("BOE/IUDSNPY", start_date=start_date, end_date=end_date)
    if not data.empty:
        plt.plot(data)
        plt.title('UK Yield Curve')
        plt.xlabel('Date')
        plt.ylabel('Yield (%)')
        st.pyplot(plt)

elif country == 'US':
    data = quandl.get("USTREASURY/YIELD", start_date=start_date, end_date=end_date)
    if not data.empty:
        plt.plot(data)
        plt.title('US Yield Curve')
        plt.xlabel('Date')
        plt.ylabel('Yield (%)')
        st.pyplot(plt)

elif country == 'Eurozone':
    data = quandl.get("ECB/EONIA", start_date=start_date, end_date=end_date)
    if not data.empty:
        plt.plot(data)
        plt.title('Eurozone Yield Curve')
        plt.xlabel('Date')
        plt.ylabel('Yield (%)')
        st.pyplot(plt)

# Display Economic Indicators
if indicator == 'Inflation Rate':
    uk_data = quandl.get("RATEINF/INFLATION_GBR", start_date=start_date, end_date=end_date)
    us_data = quandl.get("RATEINF/INFLATION_USA", start_date=start_date, end_date=end_date)
    jp_data = quandl.get("RATEINF/INFLATION_JPN", start_date=start_date, end_date=end_date)
    
    if not uk_data.empty:
        st.write(f"UK: Inflation rate {uk_data['Value'].iloc[-1]}%")
    if not us_data.empty:
        st.write(f"US: Inflation rate {us_data['Value'].iloc[-1]}%")
    if not jp_data.empty:
        st.write(f"Japan: Inflation rate {jp_data['Value'].iloc[-1]}%")


# Economic Calendar
st.subheader("Economic Calendar")
iframe_code = '''
<iframe src="https://sslecal2.investing.com?columns=exc_flags,exc_currency,exc_importance,exc_actual,exc_forecast,exc_previous&features=datepicker,timezone&countries=25,32,6,37,72,22,17,39,14,10,35,43,56,36,110,11,26,12,4,5&calType=day&timeZone=15&lang=1" width="650" height="467" frameborder="0" allowtransparency="true" marginwidth="0" marginheight="0"></iframe>
'''
st.components.v1.html(iframe_code, height=500)
